generator client {
    provider   = "prisma-client-js"
    engineType = "library"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

//--------------------------------------------------------------------
// Core User & Authentication Models
//--------------------------------------------------------------------

model User {
    id            String    @id @default(auto()) @map("_id") @db.ObjectId
    name          String?
    email         String    @unique
    emailVerified DateTime?
    image         String?
    password      String? // Hashed password for credentials provider
    role          UserRole  @default(USER)

    // Relations
    accounts   Account[]
    sessions   Session[]
    stores     Store[]
    products   Product[]
    ads        Ad[]
    adDrafts   AdDraft[]
    variables  Variable[]
    templates  Template[]
    categories Category[]
    folders    AssetFolder[]

    // Interactions
    templateLikes     TemplateLike[]
    templateFavorites TemplateFavorite[]
    templateVisits    TemplateVisit[]
    feedbacks         Feedback[]
    notifications     Notification[]

    // Billing & Subscriptions
    stripeCustomerId String?
    subscriptionId   String?       @db.ObjectId
    subscription     Subscription? @relation("UserSubscription")
    creditWallet     CreditWallet?
    invoices         Invoice[]

    // Status
    isActive         Boolean    @default(true)
    twoFactorEnabled Boolean    @default(false)
    createdAt        DateTime   @default(now())
    updatedAt        DateTime   @updatedAt
    auditLogs        AuditLog[]

    @@index([stripeCustomerId])
    @@map("users")
}

enum UserRole {
    USER
    ADMIN
    GUEST
}

model Account {
    id                String  @id @default(auto()) @map("_id") @db.ObjectId
    userId            String  @db.ObjectId
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.String
    access_token      String? @db.String
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.String
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model Session {
    id           String   @id @default(auto()) @map("_id") @db.ObjectId
    sessionToken String   @unique
    userId       String   @db.ObjectId
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model VerificationToken {
    id         String    @id @default(auto()) @map("_id") @db.ObjectId
    identifier String // Email or user ID
    token      String    @unique
    type       TokenType
    expires    DateTime
    createdAt  DateTime  @default(now())

    @@unique([identifier, token])
    @@map("verification_tokens")
}

enum TokenType {
    EMAIL_VERIFICATION
    PASSWORD_RESET
}

//--------------------------------------------------------------------
// Store & Inventory Models
//--------------------------------------------------------------------

model Store {
    id       String        @id @default(auto()) @map("_id") @db.ObjectId
    userId   String        @db.ObjectId
    name     String
    platform StorePlatform
    storeUrl String

    shopifyDomain String?

    apiKey      String?
    apiSecret   String?
    accessToken String?

    isActive   Boolean    @default(true)
    lastSyncAt DateTime?
    syncStatus SyncStatus @default(PENDING)

    metadata Json?

    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    products Product[]

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("stores")
}

enum StorePlatform {
    SHOPIFY
}

enum SyncStatus {
    PENDING
    SYNCING
    COMPLETED
    FAILED
}

model Product {
    id      String  @id @default(auto()) @map("_id") @db.ObjectId
    storeId String? @db.ObjectId
    userId  String? @db.ObjectId

    // Product details
    externalId  String? // ID from Shopify/WooCommerce
    sku         String?
    title       String
    description String?
    productType String? // e.g., "Clothing", "Electronics"

    // Product source tracking
    productSource  ProductSource @default(STORE)
    sourceMetadata Json? // Platform-specific metadata

    // Images (embedded array)
    images ProductImage[]

    // Variants (embedded array for 1-to-few relationship)
    variants ProductVariant[]

    // Status
    isActive Boolean @default(true)
    inStock  Boolean @default(true)

    // Pricing (Multi-currency)
    prices ProductPrice[]

    store       Store?       @relation(fields: [storeId], references: [id], onDelete: Cascade)
    user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
    categoryIds String[]     @db.ObjectId
    categories  Category[]   @relation(fields: [categoryIds], references: [id])
    folderId    String?      @db.ObjectId
    folder      AssetFolder? @relation(fields: [folderId], references: [id])

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([storeId, externalId])
    @@index([sku])
    @@index([userId])
    @@index([storeId])
    @@index([categoryIds])
    @@index([folderId])
    @@map("products")
}

model AssetFolder {
    id       String  @id @default(auto()) @map("_id") @db.ObjectId
    userId   String  @db.ObjectId
    name     String
    parentId String? @db.ObjectId

    // Relations
    user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    parent   AssetFolder?  @relation("NestedFolders", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    children AssetFolder[] @relation("NestedFolders")
    products Product[]

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("asset_folders")
}

enum ProductSource {
    STORE // Synced from connected store (Shopify, etc.)
    UPLOADED // Manually uploaded by user
}

type ProductImage {
    url      String
    alt      String?
    position Int     @default(0)
}

type ProductVariant {
    id      String  @default(uuid())
    title   String
    sku     String?
    inStock Boolean @default(true)
    options Json? // Dynamic options
}

type ProductPrice {
    currency Currency
    amount   Float
}

model Category {
    id          String  @id @default(auto()) @map("_id") @db.ObjectId
    userId      String? @db.ObjectId // Optional - can be global or user-specific
    name        String
    slug        String
    description String?
    parentId    String? @db.ObjectId

    // Icon/Image
    icon String?

    // Relations
    productIds String[]  @db.ObjectId
    products   Product[] @relation(fields: [productIds], references: [id])

    templateIds String[]   @db.ObjectId
    templates   Template[] @relation(fields: [templateIds], references: [id])

    user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, slug]) // Unique slug per user
    @@index([userId])
    @@map("categories")
}

//--------------------------------------------------------------------
// Ad Template System
//--------------------------------------------------------------------

model Variable {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @db.ObjectId

    name         String
    label        String
    type         VariableType
    placeholder  String?
    defaultValue String?
    required     Boolean      @default(false)
    validation   Json? // Validation rules (min, max, pattern, etc.)

    // Usage tracking with details
    usageCount      Int             @default(0)
    usedInTemplates VariableUsage[] // Embedded array

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@map("variables")
}

enum VariableType {
    TEXT
    TEXTAREA
    NUMBER
    SELECT
    COLOR
    IMAGE_URL
}

type VariableUsage {
    templateId   String
    templateName String
    prompt       String // The template's prompt
    previewUrl   String? // Template preview image
}

model Template {
    id          String  @id @default(auto()) @map("_id") @db.ObjectId
    userId      String? @db.ObjectId
    name        String
    description String?

    // Template content
    promptTemplate String // Template with {{variable}} placeholders
    variableIds    String[] @db.ObjectId // References to Variable model

    // Preview generation inputs
    referenceAdImage  String? // Reference ad for style
    productImage      String? // Product image for preview
    previewImages     String[] // Generated previews
    previewAnalyses   String[] // Analysis results for each preview
    referenceAnalysis String? // Cached analysis for referenceAdImage (Optimized)

    // Category assignments (many-to-many relation)
    categoryIds String[]   @db.ObjectId
    categories  Category[] @relation(fields: [categoryIds], references: [id])

    assignedUserIds String[] @db.ObjectId

    // Media type
    mediaType MediaType @default(IMAGE)

    // Status
    isActive Boolean @default(true)
    isPublic Boolean @default(true)

    // Stats
    usageCount  Int @default(0)
    likesCount  Int @default(0)
    visitsCount Int @default(0)

    // Relations
    user      User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
    ads       Ad[]
    likes     TemplateLike[]
    favorites TemplateFavorite[]
    visits    TemplateVisit[]

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([isActive])
    @@index([categoryIds])
    @@index([isActive, categoryIds]) // Optimized for filtering
    @@map("templates")
}

//--------------------------------------------------------------------
// Template Interactions
//--------------------------------------------------------------------

model TemplateLike {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    userId     String   @db.ObjectId
    templateId String   @db.ObjectId
    createdAt  DateTime @default(now())

    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

    @@unique([userId, templateId])
    @@map("template_likes")
}

model TemplateFavorite {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    userId     String   @db.ObjectId
    templateId String   @db.ObjectId
    createdAt  DateTime @default(now())

    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

    @@unique([userId, templateId])
    @@map("template_favorites")
}

model TemplateVisit {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    userId     String   @db.ObjectId
    templateId String   @db.ObjectId
    visitedAt  DateTime @default(now())

    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

    @@index([userId, templateId])
    @@map("template_visits")
}

//--------------------------------------------------------------------
// Feedback & Support
//--------------------------------------------------------------------

model Feedback {
    id         String         @id @default(auto()) @map("_id") @db.ObjectId
    userId     String         @db.ObjectId
    type       FeedbackType   @default(GENERAL)
    subject    String
    content    String
    status     FeedbackStatus @default(PENDING)
    adminNotes String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("feedbacks")
}

enum FeedbackType {
    GENERAL
    BUG
    FEATURE_REQUEST
    IMPROVEMENT
}

enum FeedbackStatus {
    PENDING
    REVIEWED
    RESOLVED
    REJECTED
}

//--------------------------------------------------------------------
// Notifications
//--------------------------------------------------------------------

model Notification {
    id      String           @id @default(auto()) @map("_id") @db.ObjectId
    userId  String           @db.ObjectId
    type    NotificationType
    title   String
    message String
    link    String? // Optional link to redirect on click
    isRead  Boolean          @default(false)

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([isRead])
    @@map("notifications")
}

enum NotificationType {
    INFO
    SUCCESS
    WARNING
    ERROR
    AD_COMPLETED
    AD_FAILED
    FEEDBACK_RESPONSE
    BILLING
}

//--------------------------------------------------------------------
// Ad Generation & Monitoring
//--------------------------------------------------------------------

model Ad {
    id              String   @id @default(auto()) @map("_id") @db.ObjectId
    userId          String   @db.ObjectId
    productIds      String[] @db.ObjectId // IDs of products used in this ad
    templateId      String?  @db.ObjectId
    generationJobId String?  @db.ObjectId

    // Ad details
    title           String?
    assembledPrompt String // Final prompt sent to AI
    variableValues  Json // User-provided variable values

    // Media type
    mediaType MediaType @default(IMAGE)

    // Generation parameters
    aspectRatio   String? // "1:1", "16:9", "9:16", "4:5"
    variantsCount Int? // Number of variants generated (1-4)
    duration      Int? // For video ads - in seconds

    // Generated images
    imageUrl     String? // Primary image URL
    imageUrls    String[] // All variant URLs
    cloudinaryId String? // Primary image storage ID
    storagePaths String[] // All storage IDs

    // Generated videos
    videoUrl  String? // Primary video URL
    videoUrls String[] // All video variant URLs

    // Webhook tracking
    webhookJobId String? // External webhook job ID

    // Generation status
    status AdStatus @default(PENDING)

    // Analysis Result
    resultAnalysis String?

    // Metadata
    metadata Json? // Generation parameters, model used, etc.

    // Video Script (Text or Voice)
    videoScript Json?

    // Relations
    user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    template      Template?      @relation(fields: [templateId], references: [id])
    generationJob GenerationJob? @relation(fields: [generationJobId], references: [id])

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([status])
    @@index([userId, status, createdAt])
    @@map("ads")
}

enum MediaType {
    IMAGE
    VIDEO
}

enum AdStatus {
    PENDING // Waiting to be sent to n8n
    PROCESSING // Sent to n8n, waiting for response
    COMPLETED // Successfully generated
    FAILED // Generation failed
    CANCELLED // Manually cancelled by user
}

model AdDraft {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @db.ObjectId

    // Step tracking
    currentStep Int @default(1) // 1 = product, 2 = template, 3 = customize

    // Step 1: Product selection
    productId String? @db.ObjectId

    // Step 2: Template selection
    templateId String? @db.ObjectId

    // Step 3: Variable values
    variableValues Json? // User-provided variable values

    // Additional user prompt (optional)
    userPrompt String?

    // Metadata for storing mode and manual product data
    metadata Json?

    // Video Script (from customization step)
    videoScript Json?

    // Expiration
    expiresAt DateTime // Auto-delete after 7 days

    // Relations
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([expiresAt])
    @@map("ad_drafts")
}

model GenerationJob {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    // n8n webhook details
    webhookUrl      String
    requestPayload  Json
    responsePayload Json?

    // Status tracking
    status       JobStatus @default(PENDING)
    errorMessage String?

    // Retry logic
    retryCount Int @default(0)
    maxRetries Int @default(3)

    // Relations
    ads Ad[]

    // Timestamps
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    completedAt DateTime?

    @@index([status])
    @@map("generation_jobs")
}

enum JobStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    CANCELLED
}

//--------------------------------------------------------------------
// Subscription & Billing System
//--------------------------------------------------------------------

// Plan type distinguishes pre-packaged plans from custom/PAYG.
// CUSTOM plans are regular Plan records with isPublic = false.
enum PlanType {
    FREE
    STARTER
    PRO
    BUSINESS
    PAYG // Pay As You Go — no monthly credits, user purchases top-up packs
    CUSTOM // Admin-created bespoke plan for a specific client
}

enum Currency {
    USD
    PKR
}

// Embedded per-currency, per-interval pricing (replaces flat price + billingInterval on Plan)
type PlanPrice {
    currency      Currency
    interval      BillingInterval
    amount        Float
    stripePriceId String? // Stripe Price ID for this specific currency/interval combo
}

model Plan {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    name        String   @unique
    slug        String   @unique // URL-friendly identifier, e.g. "pro", "business"
    type        PlanType
    description String?

    // Pricing — one entry per (currency × interval) combination
    prices            PlanPrice[]
    yearlyDiscountPct Float? // Display hint, e.g. 20 = "Save 20%"

    // Limits
    creditsPerMonth Float // 0 for PAYG
    storesLimit     Int // Use 9999 for "unlimited"

    // Features (flexible key-value flags, e.g. { premiumTemplates: true })
    features Json?

    isActive Boolean @default(true)
    isPublic Boolean @default(true) // false for CUSTOM plans (not shown on pricing page)

    // Relations
    subscriptions Subscription[]
    invoices      Invoice[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([isActive])
    @@index([type])
    @@map("plans")
}

model Subscription {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @unique @db.ObjectId
    planId String @db.ObjectId

    stripeSubscriptionId String?            @unique
    status               SubscriptionStatus @default(INCOMPLETE)
    interval             BillingInterval    @default(MONTHLY) // What the user is billed on

    currentPeriodStart DateTime?
    currentPeriodEnd   DateTime?
    cancelAtPeriodEnd  Boolean   @default(false)

    // Scheduled plan change (at period end). Admin sets this when downgrading.
    pendingPlanId String? @db.ObjectId

    // Relations
    user     User      @relation("UserSubscription", fields: [userId], references: [id], onDelete: Cascade)
    plan     Plan      @relation(fields: [planId], references: [id])
    invoices Invoice[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("subscriptions")
}

enum SubscriptionStatus {
    ACTIVE
    PAST_DUE
    CANCELED
    INCOMPLETE
    INCOMPLETE_EXPIRED
    TRIALING
    UNPAID
    PAUSED
}

// CreditWallet replaces the flat User.credits field.
// One wallet per user — created automatically on registration.
model CreditWallet {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @unique @db.ObjectId

    balance        Float @default(0) // Current spendable credits
    lifetimeEarned Float @default(0) // All-time credits granted (for analytics)
    lifetimeSpent  Float @default(0) // All-time credits consumed (for analytics)

    user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    topUps CreditTopUp[]

    updatedAt DateTime @updatedAt

    @@map("credit_wallets")
}

// Captures one-time credit purchases (PAYG packs or ad-hoc top-ups).
model CreditTopUp {
    id       String @id @default(auto()) @map("_id") @db.ObjectId
    walletId String @db.ObjectId

    credits               Float // Credits granted
    amount                Float // Amount paid
    currency              Currency
    stripePaymentIntentId String?     @unique
    status                TopUpStatus @default(PENDING)

    wallet    CreditWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
    createdAt DateTime     @default(now())

    @@index([walletId])
    @@map("credit_top_ups")
}

enum TopUpStatus {
    PENDING
    COMPLETED
    FAILED
    REFUNDED
}

model UsageRecord {
    id       String  @id @default(auto()) @map("_id") @db.ObjectId
    userId   String  @db.ObjectId
    walletId String? @db.ObjectId // Link to the wallet for easy balance reconciliation

    type         UsageType
    creditAmount Float // Negative for deduction, positive for refill
    description  String?

    // Context (optional)
    adId       String? @db.ObjectId
    templateId String? @db.ObjectId

    createdAt DateTime @default(now())

    @@index([userId])
    @@index([userId, createdAt])
    @@map("usage_records")
}

enum UsageType {
    AD_GENERATION
    TEMPLATE_PREVIEW
    MONTHLY_REFILL
    TOPUP_PURCHASE
    REFUND
    ADMIN_ADJUSTMENT
}

enum BillingInterval {
    MONTHLY
    YEARLY
}

model Invoice {
    id       String  @id @default(auto()) @map("_id") @db.ObjectId
    userId   String  @db.ObjectId
    stripeId String? @unique

    subscriptionId String?  @db.ObjectId
    planId         String?  @db.ObjectId
    amount         Float
    currency       String   @default("usd")
    status         String
    date           DateTime @default(now())
    pdfUrl         String?
    number         String?

    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
    plan         Plan?         @relation(fields: [planId], references: [id], onDelete: SetNull)

    @@index([userId])
    @@map("invoices")
}

//--------------------------------------------------------------------
// Audit Logging
//--------------------------------------------------------------------

model AuditLog {
    id         String  @id @default(auto()) @map("_id") @db.ObjectId
    userId     String  @db.ObjectId // Admin who performed the action
    action     String // e.g., "DELETE_USER", "UPDATE_PLAN"
    resource   String // e.g., "User", "Plan"
    resourceId String? // ID of the affected resource
    details    Json? // Specific changes or metadata
    ipAddress  String?
    userAgent  String?

    timestamp DateTime @default(now())

    user User @relation(fields: [userId], references: [id])

    @@index([userId])
    @@index([action])
    @@index([timestamp])
    @@map("audit_logs")
}
